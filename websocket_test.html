<!DOCTYPE html>
<html>
<head>
    <title>Nexagent WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        #status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .message.sent {
            background-color: #e6f7ff;
        }
        .message.received {
            background-color: #f0f0f0;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nexagent WebSocket Test</h1>
        <div id="status">Disconnected</div>

        <div class="controls">
            <input type="text" id="conversationId" placeholder="Conversation ID (e.g., mock-1)" value="mock-1">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <div class="controls">
            <input type="text" id="messageInput" placeholder="Message to send" disabled>
            <button id="sendBtn" disabled>Send</button>
            <button id="pingBtn" disabled>Send Ping</button>
        </div>

        <h3>Messages</h3>
        <div id="messages"></div>
    </div>

    <script>
        // DOM elements
        const statusElement = document.getElementById('status');
        const messagesElement = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const pingBtn = document.getElementById('pingBtn');
        const conversationIdInput = document.getElementById('conversationId');

        // WebSocket connection
        let socket = null;
        let reconnectAttempts = 0;
        let reconnectInterval = null;

        // Connect to WebSocket
        function connect() {
            const conversationId = conversationIdInput.value.trim() || 'mock-1';

            // Update UI
            statusElement.textContent = 'Connecting...';
            statusElement.style.color = 'orange';

            // Create WebSocket connection
            socket = new WebSocket(`ws://localhost:8000/api/ws/timeline/${conversationId}`);

            // Connection opened
            socket.addEventListener('open', (event) => {
                statusElement.textContent = 'Connected!';
                statusElement.style.color = 'green';

                // Enable UI elements
                disconnectBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                pingBtn.disabled = false;
                connectBtn.disabled = true;
                conversationIdInput.disabled = true;

                // Reset reconnect attempts
                reconnectAttempts = 0;
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }

                // Add a message to the messages element
                addMessage('WebSocket connection established', 'system');
            });

            // Listen for messages
            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addMessage(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
                } catch (error) {
                    addMessage(`Received (non-JSON): ${event.data}`, 'received');
                }
            });

            // Connection closed
            socket.addEventListener('close', (event) => {
                statusElement.textContent = `Disconnected (code: ${event.code}, reason: ${event.reason || 'none'})`;
                statusElement.style.color = 'red';

                // Disable UI elements
                disconnectBtn.disabled = true;
                messageInput.disabled = true;
                sendBtn.disabled = true;
                pingBtn.disabled = true;
                connectBtn.disabled = false;
                conversationIdInput.disabled = false;

                addMessage(`WebSocket connection closed (code: ${event.code}, reason: ${event.reason || 'none'})`, 'system');

                // Auto-reconnect if not a normal closure
                if (event.code !== 1000 && event.code !== 1001) {
                    if (reconnectAttempts < 5) {
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        addMessage(`Attempting to reconnect in ${delay/1000} seconds...`, 'system');

                        setTimeout(() => {
                            reconnectAttempts++;
                            connect();
                        }, delay);
                    } else {
                        addMessage('Maximum reconnect attempts reached. Please reconnect manually.', 'system');
                    }
                }
            });

            // Connection error
            socket.addEventListener('error', (error) => {
                statusElement.textContent = 'Connection error';
                statusElement.style.color = 'red';
                addMessage('WebSocket error occurred', 'system');
                console.error('WebSocket error:', error);
            });
        }

        // Disconnect from WebSocket
        function disconnect() {
            if (socket) {
                socket.close(1000, 'User initiated disconnect');
            }
        }

        // Send a message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                try {
                    // Try to parse as JSON first
                    const jsonData = JSON.parse(message);
                    socket.send(message);
                    addMessage(`Sent: ${JSON.stringify(jsonData, null, 2)}`, 'sent');
                } catch (error) {
                    // If not valid JSON, send as plain text
                    socket.send(message);
                    addMessage(`Sent: ${message}`, 'sent');
                }
                messageInput.value = '';
            }
        }

        // Send a ping
        function sendPing() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const pingData = JSON.stringify({ type: 'ping', timestamp: Date.now() });
                socket.send(pingData);
                addMessage(`Sent: ${pingData}`, 'sent');
            }
        }

        // Add a message to the messages element
        function addMessage(text, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${text}`;

            messagesElement.appendChild(messageElement);
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendBtn.addEventListener('click', sendMessage);
        pingBtn.addEventListener('click', sendPing);

        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Check backend health on page load
        fetch('http://localhost:8000/api/health')
            .then(response => response.json())
            .then(data => {
                addMessage(`Backend health check: ${JSON.stringify(data)}`, 'system');
                statusElement.textContent = 'Ready to connect';
                statusElement.style.color = 'blue';
            })
            .catch(error => {
                addMessage(`Backend health check failed: ${error.message}`, 'system');
                statusElement.textContent = 'Backend unavailable';
                statusElement.style.color = 'red';
            });
    </script>
</body>
</html>